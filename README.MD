# Carambola Fruter铆a

Carambola fruter铆a es un proyecto con fines educativos para mostrar algunas caracter铆sticas interesantes de Dialogflow para la creaci贸n de un asistente virtual para un e-commerce.

## Instalaci贸n 

Crea un agente en dialogflow.cloud.google.com e importa el fichero .zip disponible en la carpeta AgenteDialogflow.

Ve al proyecto de Google Cloud asociado al agente de Dialogflow clicando sobre Ajustes > General > click sobre el nombre del proyecto.

Busca la opci贸n IAM & Admin > Service Accounts > + Create Service Account > Da un nombre a la cuenta de servicio, dale permisos de "Dialogflow API Client" 
En el listado que aparece a continuaci贸n de cuestas de servicio, selecciona las opciones de la que acabas de crear y pulsa sobre "Create Key" > JSON
Copia el contenido del fichero dentro del fichero credentials.js, service-account-telegram.json e index-inline.js en la constante credentials.
Ahora hay que darle permisos a esa cuenta de servicio para que acceda a:
* Google Sheets: crea un google spreadsheet y compartelo con la cuenta de servicio Share > a帽adir la direcci贸n de correo que aparece en las credenciales en el campo client_email. En el fichero credentials.js a帽ade tb el ID del google spreadsheet que se puede obtener de la url https://docs.google.com/spreadsheets/d/[ID] y en el fichero index-inline.js p茅galo en la constante SPREADSHEET_ID.
* Activa la Google Sheets API desde el proyecto de Google cloud buscando "Google Sheets API" y pulsando sobre habilitar. dem con Cloud Vision API.

Nota: es posible que tengas que asigar una cuenta de facturaci贸n al proyecto (con su correspondiente tarjeta de cr茅dito) para activar todas estas funcionalidades. En general, para un uso did谩ctico no deber铆a cobrarte nada porque el uso que se va a hacer es bajo.

Una vez que tienes todo configurado, tienes varias partes que probar:
* Agente de Dialogflow
* Fulfillment (webhook o in-line editor)
* Adaptador de canal Telegram con visi贸n artificial

### Agente de Dialogflow

En el agente de Dialogflow creado en la instalaci贸n ve a Ajustes > Export and Import > Restore from zip. 
Selecciona el fichero AgenteDialogflow > Carambola-Fruter铆a_Agente_Dialogflow.zip

Ahora ya tendr谩s los intens de la fruter铆a y podr谩s probarlos en la consola de prueba a la derecha en Dialogflow.

### Fulfillment. Opci贸n 1 - Webhook

En la versi贸n webhook usarmos el fichero index.js.

Primero instalamos las dependencias del proyecto:

```
npm i
node index.js
```
Si todas las credenciales son correctas ya tendremos nuestro servidor escuchando en localhost. Ahora deberemos exponer el servicio a internet, para ello podemos utilizar la herramienta ngrok y ejecutar el comando:

```
ngrok http 3000
```

Si no tienes la herramienta ngrok puedes descargarla aqu铆: https://ngrok.com/download

A continuaci贸n en Dialogflow ve a la pesta帽a Fulfillment y seleccionar Webhook e introducir la URL que ha devuelto ngrok en el paso anterior (la url con https)

### Fulfillment. Opci贸n 2 - Inline editor

Entra en el agente de Dialogflow y copia el c贸digo del fichero AgenteDialogflow > index-inline.js. P茅galo en la pesta帽a index.js. En la package.json copia y pega las dependencias nuevas que no est茅n en apartado "dependencies".

Pulsa sobre Deploy y espera a que el servicio est茅 publicado. 

Nota: es posible que tengas que asigar una cuenta de facturaci贸n al proyecto 

### Adaptador de canal Telegram con visi贸n artificial

Por 煤ltimo si quieres probar el adaptador de canal para Telegram con visi贸n artificial sigue los siguientes pasos:
* Entra en Telegram y busca el contacto BotFather. Escribe /newbot y sigue las instrucciones. Al final unos sencillos pasos BotFather te entregar谩 un token que deber谩s pegar en el fichero AdaptadorTelegram > config-telegram.js en la constante Telegram_token. Tambi茅n rellena el id del agente de Dialogflow en la constante projectIdDF. Este ID lo puedes obtener en Dialogflow > Ajustes > Project ID.

Para ejecutar el adaptador:

```
cd AdaptadorTelegram
node adaptador_Canal_Telegram.js
```

Ahora entra en Telegram, busca el bot que acabas de crear y comienza a hablar.

# Autor

David Faustino P茅rez Garc铆a

Gracias, cualquier duda en los comentarios!

Happy coding





